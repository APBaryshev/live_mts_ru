name: Playwright Tests with Allure Reports

on:
    workflow_dispatch:
        inputs:
            test_type:
                description: Choose test type
                required: true
                default: smoke
                type: choice
                options:
                    - smoke
                    - features
                    - api
                    - all
    push:
        branches: [main, dev]
    pull_request:
        branches: [main]

jobs:
    download-history:
        runs-on: ubuntu-latest
        name: Download previous allure results
        outputs:
            history-exists: ${{ steps.check-history.outputs.exists }}
        steps:
            - name: Setup Python for scripts
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Check and download previous allure results
              id: check-history
              run: |
                  # Проверяем существование предыдущих результатов
                  RESPONSE=$(curl -s -L \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?name=allure-results")

                  ARTIFACTS_COUNT=$(echo $RESPONSE | python -c "import sys, json; print(len(json.load(sys.stdin)['artifacts']))")

                  if [ "$ARTIFACTS_COUNT" -gt 0 ]; then
                    ARTIFACT_ID=$(echo $RESPONSE | python -c "import sys, json; print(json.load(sys.stdin)['artifacts'][0]['id'])")
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "Previous allure results found: $ARTIFACT_ID"
                    
                    curl -L \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
                    -o artifacts.zip &&
                    mkdir -p allure-results && 
                    unzip -o artifacts.zip -d allure-results/
                    echo "Downloaded previous allure results"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "No previous allure results found"
                    mkdir -p allure-results
                  fi

            - name: Upload allure history for next jobs
              uses: actions/upload-artifact@v4
              with:
                  name: allure-results
                  path: allure-results/
                  retention-days: 1

    setup-and-test:
        runs-on: ubuntu-latest
        needs: download-history
        name: Setup and Run Tests

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright Browsers
              run: npx playwright install --with-deps

            - name: Download previous allure results
              uses: actions/download-artifact@v4
              with:
                  name: allure-results
                  path: allure-results

            - name: Run Smoke Tests
              if: github.event.inputs.test_type == 'smoke' || github.event.inputs.test_type == 'all' || github.event_name != 'workflow_dispatch'
              run: |
                  npx playwright test tests/smoke/ \
                  --reporter=line,allure-playwright \
                  || echo "Some smoke tests failed but continuing..."

            - name: Run Features Tests
              if: github.event.inputs.test_type == 'features' || github.event.inputs.test_type == 'all'
              run: |
                  npx playwright test tests/features/ \
                  --reporter=line,allure-playwright \
                  || echo "Some features tests failed but continuing..."

            - name: Run API Tests
              if: github.event.inputs.test_type == 'api' || github.event.inputs.test_type == 'all'
              run: |
                  npx playwright test tests/api/ \
                  --reporter=line,allure-playwright \
                  || echo "Some API tests failed but continuing..."

            - name: List generated allure files
              run: find allure-results -name "*.json" -o -name "*.txt" | head -10 || echo "No allure results found"

            - name: Upload test results
              uses: actions/upload-artifact@v4
              with:
                  name: allure-results
                  path: allure-results/
                  retention-days: 1
              if: always()

    generate-allure-report:
        runs-on: ubuntu-latest
        needs: setup-and-test
        name: Generate Allure Report

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Java for Allure
              uses: actions/setup-java@v3
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Install Allure
              run: |
                  wget -q https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
                  tar -zxvf allure-2.24.0.tgz -C /opt/
                  sudo ln -sf /opt/allure-2.24.0/bin/allure /usr/bin/allure
                  allure --version

            - name: Download test results
              uses: actions/download-artifact@v4
              with:
                  name: allure-results
                  path: allure-results

            - name: Generate Allure Report
              run: |
                  echo "Generating Allure report..."
                  allure generate allure-results --clean -o allure-report
                  echo "Allure report generated successfully"

            - name: List report contents
              run: ls -la allure-report/ || echo "No allure report generated"

            - name: Upload Allure Report for Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  name: github-pages
                  path: allure-report/
              if: always()

    upload-allure-report:
        runs-on: ubuntu-latest
        needs: generate-allure-report
        name: Upload Allure Report
        
        steps:
            - name: Download test results
              uses: actions/download-artifact@v4
              with:
                  name: allure-results
                  path: allure-results

            - name: Generate Allure Report
              run: |
                  wget -q https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
                  tar -zxvf allure-2.24.0.tgz -C /opt/
                  sudo ln -sf /opt/allure-2.24.0/bin/allure /usr/bin/allure
                  allure generate allure-results --clean -o public/allure

            - name: Upload Allure to Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: public/allure/
